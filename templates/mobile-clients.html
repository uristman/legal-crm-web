{% extends "mobile-base.html" %}

{% block title %}–ö–ª–∏–µ–Ω—Ç—ã - Legal CRM{% endblock %}

{% block content %}
<div class="animate-slide-up">
    <!-- Header with Search -->
    <div class="card mb-4">
        <div class="card-header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h1 class="text-lg font-semibold">–ö–ª–∏–µ–Ω—Ç—ã</h1>
                    <span class="chip">{{ clients|length }}</span>
                </div>
                <button class="mobile-nav-toggle" onclick="toggleSearch()">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Search Bar -->
        <div class="card-body" id="search-container" style="display: none;">
            <div style="position: relative;">
                <input 
                    type="text" 
                    id="search-input" 
                    class="form-input" 
                    placeholder="–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤..."
                    oninput="filterClients()"
                >
                <button 
                    class="mobile-nav-toggle" 
                    style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);"
                    onclick="clearSearch()"
                >
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="mobile-grid mb-4">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-2xl mb-2">üë•</div>
                <div class="text-2xl font-bold text-success">{{ clients|length }}</div>
                <div class="text-xs text-muted">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
            </div>
        </div>
        
        <div class="card text-center">
            <div class="card-body">
                <div class="text-2xl mb-2">üÜï</div>
                <div class="text-2xl font-bold text-warning">{{ new_clients }}</div>
                <div class="text-xs text-muted">–ù–æ–≤—ã—Ö (30 –¥–Ω–µ–π)</div>
            </div>
        </div>
    </div>

    <!-- Clients List -->
    <div class="card">
        <div class="card-body">
            {% if clients %}
            <div id="clients-list">
                {% for client in clients %}
                <div class="client-item" data-client-name="{{ client.name.lower() }}" style="border-bottom: 1px solid var(--border-color); padding: 1rem 0; {% if not loop.last %}margin-bottom: 0.5rem;{% endif %}">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <!-- Client Avatar -->
                        <div class="user-avatar" style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), #3b82f6);">
                            {{ client.name[0].upper() }}
                        </div>
                        
                        <!-- Client Info -->
                        <div style="flex: 1;" onclick="viewClient('{{ client.id }}')">
                            <div class="font-semibold text-lg">{{ client.name }}</div>
                            <div class="text-sm text-muted">üìû {{ client.phone or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</div>
                            <div class="text-sm text-muted">üìß {{ client.email or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</div>
                            
                            <!-- Status and Cases -->
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <span class="status-badge {{ 'status-active' if client.status == 'active' else 'status-inactive' }}">
                                    {{ '–ê–∫—Ç–∏–≤–Ω—ã–π' if client.status == 'active' else '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π' }}
                                </span>
                                <span class="chip">{{ client.cases_count or 0 }} –¥–µ–ª</span>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="client-actions" style="display: flex; gap: 0.25rem;">
                            <button class="mobile-nav-toggle" onclick="callClient('{{ client.phone }}')" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                </svg>
                            </button>
                            
                            <button class="mobile-nav-toggle" onclick="emailClient('{{ client.email }}')" title="–ù–∞–ø–∏—Å–∞—Ç—å email">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                    <polyline points="22,6 12,13 2,6"></polyline>
                                </svg>
                            </button>
                            
                            <button class="mobile-nav-toggle" onclick="editClient('{{ client.id }}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Last Contact Info -->
                    {% if client.last_contact %}
                    <div class="text-xs text-muted mt-2" style="padding-left: 64px;">
                        üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç: {{ client.last_contact.strftime('%d.%m.%Y') }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" style="display: none;" class="text-center text-muted py-6">
                <div class="text-4xl mb-4">üë•</div>
                <h3 class="font-semibold mb-2">–ü–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                <p class="text-sm mb-4">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                <a href="{{ url_for('add_client') }}" class="btn btn-primary">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                </a>
            </div>
            {% else %}
            <div class="text-center text-muted py-6">
                <div class="text-4xl mb-4">üë•</div>
                <h3 class="font-semibold mb-2">–ü–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                <p class="text-sm mb-4">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                <a href="{{ url_for('add_client') }}" class="btn btn-primary">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="quickAddClient()" title="–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">
        +
    </button>

    <!-- Bottom Padding for Mobile Menu -->
    <div style="height: 120px;"></div>
</div>

<!-- Quick Add Client Modal -->
<div id="quick-add-modal" class="mobile-menu-overlay" style="display: none;" onclick="closeQuickAddModal()">
    <div class="card" style="margin: 1rem; max-width: 400px;" onclick="event.stopPropagation()">
        <div class="card-body">
            <h3 class="font-semibold mb-4 text-center">‚ûï –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ</h3>
            
            <form id="quick-add-form" onsubmit="submitQuickAdd(event)">
                <div class="form-group">
                    <label class="form-label">üìù –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ *</label>
                    <input type="text" class="form-input" id="quick-client-name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="form-input" id="quick-client-phone" placeholder="+7 (999) 123-45-67" inputmode="tel">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìß Email</label>
                    <input type="email" class="form-input" id="quick-client-email" placeholder="client@example.com" inputmode="email">
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-outline" onclick="closeQuickAddModal()">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Client Details Modal -->
<div id="client-modal" class="mobile-menu-overlay" style="display: none;" onclick="closeClientModal()">
    <div class="card" style="margin: 1rem; max-width: 400px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
        <div class="card-body">
            <div id="client-details" class="text-sm">
                <!-- Client details will be populated by JavaScript -->
            </div>
            <div class="btn-group mt-4">
                <button class="btn btn-outline" onclick="closeClientModal()">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button class="btn btn-primary" id="edit-client-btn">
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.client-item {
    transition: all 0.3s ease;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
}

.client-item:hover {
    background: #f8fafc;
    transform: translateX(4px);
}

.client-item:active {
    background: #f1f5f9;
    transform: scale(0.98);
}

.client-actions {
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.client-item:hover .client-actions {
    opacity: 1;
}

.fab {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    border: none;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s ease;
    font-size: 24px;
    font-weight: 300;
}

.fab:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
}

/* Search animation */
#search-container {
    animation: slideInDown 0.3s ease-out;
    border-top: 1px solid var(--border-color);
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Mobile optimizations */
@media (max-width: 480px) {
    .client-item {
        padding: 0.75rem;
    }
    
    .user-avatar {
        width: 40px !important;
        height: 40px !important;
        font-size: 0.875rem;
    }
    
    .client-actions .mobile-nav-toggle {
        width: 36px;
        height: 36px;
    }
}

/* Empty state animations */
.empty-state {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Pull to refresh indicator */
.pull-indicator {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
}

.pull-indicator.show {
    transform: translateY(0);
}
</style>

<script>
let currentClientId = null;
let searchVisible = false;

// Toggle search visibility
function toggleSearch() {
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('search-input');
    
    searchVisible = !searchVisible;
    searchContainer.style.display = searchVisible ? 'block' : 'none';
    
    if (searchVisible) {
        setTimeout(() => searchInput.focus(), 100);
    }
}

// Clear search
function clearSearch() {
    document.getElementById('search-input').value = '';
    filterClients();
}

// Filter clients based on search
function filterClients() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const clientItems = document.querySelectorAll('.client-item');
    let visibleCount = 0;
    
    clientItems.forEach(item => {
        const clientName = item.dataset.clientName;
        const shouldShow = clientName.includes(searchTerm);
        
        item.style.display = shouldShow ? 'block' : 'none';
        if (shouldShow) visibleCount++;
    });
    
    // Show/hide empty state
    const emptyState = document.getElementById('empty-state');
    const hasClients = {{ clients|length }} > 0;
    
    if (searchTerm && hasClients && visibleCount === 0) {
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div class="text-4xl mb-4">üîç</div>
            <h3 class="font-semibold mb-2">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
            <p class="text-sm mb-4">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</p>
            <button class="btn btn-outline" onclick="clearSearch()">
                –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫
            </button>
        `;
    } else {
        emptyState.style.display = 'none';
    }
}

// View client details
function viewClient(clientId) {
    currentClientId = clientId;
    const modal = document.getElementById('client-modal');
    const details = document.getElementById('client-details');
    
    // Simulate client data - in real app, this would come from server
    const clientData = {
        name: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á',
        phone: '+7 (999) 123-45-67',
        email: 'ivanov@example.com',
        address: '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1',
        birthDate: '15.03.1985',
        status: '–ê–∫—Ç–∏–≤–Ω—ã–π',
        casesCount: 3,
        lastContact: '10.11.2024',
        notes: '–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –æ–±—â–µ–Ω–∏–µ –ø–æ email'
    };
    
    details.innerHTML = `
        <div class="text-center mb-4">
            <div class="user-avatar" style="width: 80px; height: 80px; margin: 0 auto; font-size: 2rem;">
                ${clientData.name[0].toUpperCase()}
            </div>
            <h2 class="font-bold text-xl mt-2">${clientData.name}</h2>
            <span class="status-badge status-active">${clientData.status}</span>
        </div>
        
        <div class="mobile-grid" style="gap: 0.75rem;">
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <div class="text-xs text-muted mb-1">üìû –¢–µ–ª–µ—Ñ–æ–Ω</div>
                <div class="font-medium">${clientData.phone}</div>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <div class="text-xs text-muted mb-1">üìß Email</div>
                <div class="font-medium">${clientData.email}</div>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <div class="text-xs text-muted mb-1">‚öñÔ∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ª</div>
                <div class="font-medium">${clientData.casesCount}</div>
            </div>
            <div style="padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <div class="text-xs text-muted mb-1">üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</div>
                <div class="font-medium">${clientData.lastContact}</div>
            </div>
        </div>
        
        ${clientData.address ? `
        <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
            <div class="text-xs text-muted mb-1">üìç –ê–¥—Ä–µ—Å</div>
            <div class="text-sm">${clientData.address}</div>
        </div>
        ` : ''}
        
        ${clientData.notes ? `
        <div style="margin-top: 1rem; padding: 1rem; background: #ecfdf5; border-radius: 8px;">
            <div class="text-xs text-muted mb-1">üìù –ó–∞–º–µ—Ç–∫–∏</div>
            <div class="text-sm">${clientData.notes}</div>
        </div>
        ` : ''}
    `;
    
    modal.style.display = 'block';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeClientModal() {
    const modal = document.getElementById('client-modal');
    modal.style.display = 'none';
    modal.classList.remove('active');
    document.body.style.overflow = '';
}

// Quick add client
function quickAddClient() {
    const modal = document.getElementById('quick-add-modal');
    modal.style.display = 'block';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        document.getElementById('quick-client-name').focus();
    }, 100);
}

function closeQuickAddModal() {
    const modal = document.getElementById('quick-add-modal');
    modal.style.display = 'none';
    modal.classList.remove('active');
    document.body.style.overflow = '';
    
    document.getElementById('quick-add-form').reset();
}

function submitQuickAdd(event) {
    event.preventDefault();
    
    const name = document.getElementById('quick-client-name').value.trim();
    const phone = document.getElementById('quick-client-phone').value.trim();
    const email = document.getElementById('quick-client-email').value.trim();
    
    if (!name) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞');
        return;
    }
    
    // Simulate adding client
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.classList.add('loading');
    submitBtn.disabled = true;
    
    setTimeout(() => {
        // In real app, this would make an API call
        closeQuickAddModal();
        location.reload(); // Refresh to show new client
    }, 1000);
}

// Call client
function callClient(phone) {
    if (phone && phone !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
        window.location.href = `tel:${phone}`;
    } else {
        alert('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω');
    }
}

// Email client
function emailClient(email) {
    if (email && email !== '–ù–µ —É–∫–∞–∑–∞–Ω') {
        window.location.href = `mailto:${email}`;
    } else {
        alert('Email –Ω–µ —É–∫–∞–∑–∞–Ω');
    }
}

// Edit client
function editClient(clientId) {
    // In real app, navigate to edit page
    window.location.href = `/clients/${clientId}/edit`;
}

// Pull to refresh functionality
let pullStartY = 0;
let pullCurrentY = 0;

document.addEventListener('touchstart', function(e) {
    if (window.scrollY === 0) {
        pullStartY = e.touches[0].pageY;
    }
});

document.addEventListener('touchmove', function(e) {
    if (window.scrollY === 0) {
        pullCurrentY = e.touches[0].pageY;
        const diff = pullCurrentY - pullStartY;
        
        if (diff > 50) {
            showPullIndicator();
        }
    }
});

document.addEventListener('touchend', function(e) {
    if (pullCurrentY - pullStartY > 100) {
        performRefresh();
    }
    hidePullIndicator();
});

function showPullIndicator() {
    let indicator = document.querySelector('.pull-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.className = 'pull-indicator';
        indicator.innerHTML = 'üîÑ –û—Ç–ø—É—Å—Ç–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
        document.body.appendChild(indicator);
    }
    indicator.classList.add('show');
}

function hidePullIndicator() {
    const indicator = document.querySelector('.pull-indicator');
    if (indicator) {
        indicator.classList.remove('show');
    }
}

function performRefresh() {
    // In real app, this would reload data from server
    location.reload();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add haptic feedback on iOS
    if (navigator.vibrate) {
        document.querySelectorAll('button, .client-item').forEach(element => {
            element.addEventListener('touchstart', () => {
                navigator.vibrate(10);
            });
        });
    }
    
    // Initialize pull to refresh
    pullStartY = 0;
    pullCurrentY = 0;
    
    // Auto-focus search if opened
    if (searchVisible) {
        document.getElementById('search-input').focus();
    }
});
</script>
{% endblock %}
