<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>⚖️ Legal CRM Web - Система для юристов</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Flatpickr for date/time picking -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    
    <script type="text/javascript" src="/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=ecwyKwdlJEFMowfdilsVJrF2eVU_aBovxsm4P2HxIEqPpYWia4BNu_BfkJ66kM4WBN7pQGn-qaHIYJpYh25f7GxRC29LuFs1fA3u4DB3f9tAVXfCt9rWgqIJcaUKCjXyL2sybjZC5b-DjimzCtTTCkwQHBdkkJQNqaTkryvdlU8" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9hZ2VudC5taW5pbWF4LmlvL21hdHJpeC9hcGkvdjEvc3RvcmFnZS9vYmplY3QvY2hhdC8zMzU0NTM5NjAwMjg0ODcvbGVnYWxfY3JtX3dlYi90ZW1wbGF0ZXMvaW5kZXguaHRtbA"/><style>
        /* Мобильная оптимизация */
        .mobile-stack {
            flex-direction: column;
        }
        
        .mobile-full-width {
            width: 100% !important;
            margin-bottom: 0.5rem;
        }
        
        .mobile-text-sm {
            font-size: 0.8rem;
        }
        
        .mobile-btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .navbar-nav .nav-item {
                margin-bottom: 0.5rem;
            }
            
            .container-fluid {
                padding: 0.5rem !important;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .btn {
                font-size: 0.9rem;
                padding: 0.375rem 0.75rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            /* Статистика на мобильных */
            .stats-mobile {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            
            .stats-item {
                flex: 1;
                min-width: calc(50% - 0.25rem);
                background: #f8f9fa;
                padding: 0.5rem;
                border-radius: 0.375rem;
                text-align: center;
            }
            
            .stats-number {
                font-size: 1.2rem;
                font-weight: bold;
                color: #0d6efd;
            }
            
            .stats-label {
                font-size: 0.75rem;
                color: #6c757d;
                margin-top: 0.25rem;
            }
        }
        
        /* Скрываем статистику в navbar на мобильных */
        @media (max-width: 768px) {
            .navbar-nav .stats-container {
                display: none;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
        }
        
        /* Улучшенная типографика для мобильных */
        .h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6 {
            line-height: 1.3;
        }
        
        /* Улучшенные формы на мобильных */
        .form-control, .form-select {
            font-size: 16px; /* Предотвращает zoom на iOS */
        }
        
        /* Улучшенные таблицы на мобильных */
        .table {
            font-size: 0.85rem;
        }
        
        .table th, .table td {
            padding: 0.5rem 0.25rem;
        }
        
        /* Улучшенные кнопки действий */
        .btn-action {
            padding: 0.25rem 0.5rem;
            margin: 0.1rem;
        }
        
        /* Toast для мобильных */
        .toast {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Навигационная панель -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-balance-scale me-2"></i>
                Legal CRM Web
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav me-auto">
                    <!-- Статистика для больших экранов -->
                    <div class="d-flex align-items-center text-white me-4 stats-container">
                        <div class="me-3">
                            <small>Клиенты</small>
                            <div id="stats-clients" class="fw-bold">0</div>
                        </div>
                        <div class="me-3">
                            <small>Дела</small>
                            <div id="stats-cases" class="fw-bold">0</div>
                        </div>
                        <div class="me-3">
                            <small>События сегодня</small>
                            <div id="stats-events" class="fw-bold">0</div>
                        </div>
                        <div>
                            <small>Доход (месяц)</small>
                            <div id="stats-income" class="fw-bold">0 ₽</div>
                        </div>
                    </div>
                </div>
                
                <!-- Информация о пользователе и выход -->
                <div class="navbar-nav">
                    <div class="text-white me-3 d-none" id="userInfo">
                        <small>Пользователь:</small>
                        <div id="userName" class="fw-bold"></div>
                    </div>
                    <button class="btn btn-outline-light btn-sm d-none" id="logoutBtn" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>Выйти
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="container-fluid py-3">
        <!-- Статистика для мобильных -->
        <div class="stats-mobile d-lg-none" id="mobileStats" style="display: none;">
            <div class="stats-item">
                <div class="stats-number" id="mobile-clients">0</div>
                <div class="stats-label">Клиенты</div>
            </div>
            <div class="stats-item">
                <div class="stats-number" id="mobile-cases">0</div>
                <div class="stats-label">Дела</div>
            </div>
            <div class="stats-item">
                <div class="stats-number" id="mobile-events">0</div>
                <div class="stats-label">События</div>
            </div>
            <div class="stats-item">
                <div class="stats-number" id="mobile-income">0 ₽</div>
                <div class="stats-label">Доход</div>
            </div>
        </div>

        <!-- Навигация по вкладкам -->
        <ul class="nav nav-pills nav-fill mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="clients-tab" data-bs-toggle="pill" 
                        data-bs-target="#clients-panel" type="button" role="tab">
                    <i class="fas fa-users me-2"></i>Клиенты
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cases-tab" data-bs-toggle="pill" 
                        data-bs-target="#cases-panel" type="button" role="tab">
                    <i class="fas fa-gavel me-2"></i>Дела
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="services-tab" data-bs-toggle="pill" 
                        data-bs-target="#services-panel" type="button" role="tab">
                    <i class="fas fa-briefcase me-2"></i>Услуги
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="payments-tab" data-bs-toggle="pill" 
                        data-bs-target="#payments-panel" type="button" role="tab">
                    <i class="fas fa-money-bill me-2"></i>Финансы
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="events-tab" data-bs-toggle="pill" 
                        data-bs-target="#events-panel" type="button" role="tab">
                    <i class="fas fa-calendar me-2"></i>Календарь
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="pill" 
                        data-bs-target="#reports-panel" type="button" role="tab">
                    <i class="fas fa-chart-bar me-2"></i>Отчеты
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sync-tab" data-bs-toggle="pill" 
                        data-bs-target="#sync-panel" type="button" role="tab">
                    <i class="fas fa-cloud-upload-alt me-2"></i>Синхронизация
                </button>
            </li>
        </ul>

        <!-- Контент вкладок -->
        <div class="tab-content" id="mainTabsContent">
            
            <!-- Вкладка Клиенты -->
            <div class="tab-pane fade show active" id="clients-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>Управление клиентами
                        </h5>
                        <button class="btn btn-success" data-bs-toggle="modal" 
                                data-bs-target="#clientModal" onclick="openClientModal()">
                            <i class="fas fa-plus me-2"></i>Добавить клиента
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Поиск клиентов -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="clients-search" 
                                           placeholder="Поиск по имени, телефону или email">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Таблица клиентов -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="clients-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ФИО</th>
                                        <th>Телефон</th>
                                        <th>Email</th>
                                        <th>Статус</th>
                                        <th>Дата создания</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Дела -->
            <div class="tab-pane fade" id="cases-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-gavel me-2"></i>Управление делами
                        </h5>
                        <button class="btn btn-success" data-bs-toggle="modal" 
                                data-bs-target="#caseModal" onclick="openCaseModal()">
                            <i class="fas fa-plus me-2"></i>Добавить дело
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="cases-table">
                                <thead>
                                    <tr>
                                        <th>Номер дела</th>
                                        <th>Клиент</th>
                                        <th>Суд</th>
                                        <th>Тип дела</th>
                                        <th>Стадия</th>
                                        <th>Дата начала</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Услуги -->
            <div class="tab-pane fade" id="services-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-briefcase me-2"></i>Управление услугами
                        </h5>
                        <button class="btn btn-success" data-bs-toggle="modal" 
                                data-bs-target="#serviceModal" onclick="openServiceModal()">
                            <i class="fas fa-plus me-2"></i>Добавить услугу
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="services-table">
                                <thead>
                                    <tr>
                                        <th>Услуга</th>
                                        <th>Клиент</th>
                                        <th>Дело</th>
                                        <th>Дата</th>
                                        <th>Часы</th>
                                        <th>Стоимость</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Финансы -->
            <div class="tab-pane fade" id="payments-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-money-bill me-2"></i>Управление платежами
                        </h5>
                        <button class="btn btn-success" data-bs-toggle="modal" 
                                data-bs-target="#paymentModal" onclick="openPaymentModal()">
                            <i class="fas fa-plus me-2"></i>Добавить платеж
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="payments-table">
                                <thead>
                                    <tr>
                                        <th>Клиент</th>
                                        <th>Дело</th>
                                        <th>Сумма</th>
                                        <th>Тип</th>
                                        <th>Дата</th>
                                        <th>Способ</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Календарь -->
            <div class="tab-pane fade" id="events-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar me-2"></i>Календарь событий
                        </h5>
                        <button class="btn btn-success" data-bs-toggle="modal" 
                                data-bs-target="#eventModal" onclick="openEventModal()">
                            <i class="fas fa-plus me-2"></i>Добавить событие
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="events-table">
                                <thead>
                                    <tr>
                                        <th>Название</th>
                                        <th>Тип</th>
                                        <th>Дата</th>
                                        <th>Время</th>
                                        <th>Клиент</th>
                                        <th>Дело</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут загружены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Отчеты -->
            <div class="tab-pane fade" id="reports-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Отчеты и аналитика
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3 id="total-clients">0</h3>
                                        <p class="mb-0">Всего клиентов</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 id="total-cases">0</h3>
                                        <p class="mb-0">Активных дел</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 id="total-income">0 ₽</h3>
                                        <p class="mb-0">Доход за месяц</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h3 id="total-services">0</h3>
                                        <p class="mb-0">Услуг за месяц</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>Функции отчетов</h6>
                                    <p class="mb-0">Подробная аналитика будет добавлена в следующих версиях. Сейчас доступна базовая статистика по ключевым показателям.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка Синхронизация с Яндекс.Диском -->
            <div class="tab-pane fade" id="sync-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Синхронизация с Яндекс.Диском
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Статус синхронизации -->
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3 id="sync-status-indicator"><i class="fas fa-spinner fa-spin"></i></h3>
                                        <p class="mb-0">Статус</p>
                                        <small id="sync-status-text">Загрузка...</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 id="last-sync-time">Не определено</h3>
                                        <p class="mb-0">Последняя синхронизация</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 id="backup-count">0</h3>
                                        <p class="mb-0">Резервных копий</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Настройки подключения -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>Настройки подключения
                                </h6>
                            </div>
                            <div class="card-body">
                                <form id="yandex-config-form">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="yandex-username" class="form-label">
                                                <i class="fas fa-user me-1"></i>Логин Яндекс.Паспорта
                                            </label>
                                            <input type="text" class="form-control" id="yandex-username" 
                                                   placeholder="your.username" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="yandex-password" class="form-label">
                                                <i class="fas fa-lock me-1"></i>Пароль Яндекс.Паспорта
                                            </label>
                                            <input type="password" class="form-control" id="yandex-password" 
                                                   placeholder="Ваш пароль" required>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="testYandexConnection()">
                                            <i class="fas fa-plug me-2"></i>Проверить подключение
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="setupYandexSync()">
                                            <i class="fas fa-save me-2"></i>Сохранить настройки
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Управление синхронизацией -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-sync-alt me-2"></i>Управление синхронизацией
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <button type="button" class="btn btn-info w-100" onclick="uploadToCloud()">
                                            <i class="fas fa-cloud-upload-alt me-2"></i>Синхронизировать с облаком
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button type="button" class="btn btn-warning w-100" onclick="downloadFromCloud()">
                                            <i class="fas fa-cloud-download-alt me-2"></i>Загрузить из облака
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Автоматическая синхронизация -->
                                <div class="mt-3 p-3 border rounded">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">
                                                <i class="fas fa-clock me-2"></i>Автоматическая синхронизация
                                            </h6>
                                            <small class="text-muted">
                                                Данные будут автоматически синхронизироваться с облаком
                                            </small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="auto-sync-toggle" 
                                                       onchange="toggleAutoSync(this)">
                                                <label class="form-check-label" for="auto-sync-toggle">
                                                    Включено
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- История резервных копий -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-history me-2"></i>История резервных копий
                                </h6>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="cleanupOldBackups()">
                                    <i class="fas fa-trash-alt me-1"></i>Очистить старые
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm" id="backup-history-table">
                                        <thead>
                                            <tr>
                                                <th>Дата создания</th>
                                                <th>Размер</th>
                                                <th>Действия</th>
                                            </tr>
                                        </thead>
                                        <tbody id="backup-history-body">
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">
                                                    Загрузка истории резервных копий...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно клиента -->
    <div class="modal fade" id="clientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clientModalTitle">
                        <i class="fas fa-user-plus me-2"></i>Добавить клиента
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clientForm">
                        <input type="hidden" id="clientId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ФИО *</label>
                                <input type="text" class="form-control" id="clientFullName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Телефон</label>
                                <input type="tel" class="form-control" id="clientPhone">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="clientEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Статус</label>
                                <select class="form-select" id="clientStatus">
                                    <option value="Активный">Активный</option>
                                    <option value="Неактивный">Неактивный</option>
                                    <option value="Потенциальный">Потенциальный</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Адрес</label>
                                <input type="text" class="form-control" id="clientAddress">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Паспортные данные</label>
                                <input type="text" class="form-control" id="clientPassport">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ИНН</label>
                                <input type="text" class="form-control" id="clientInn">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Примечания</label>
                            <textarea class="form-control" id="clientNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveClient()">
                        <i class="fas fa-save me-2"></i>Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно дела -->
    <div class="modal fade" id="caseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="caseModalTitle">
                        <i class="fas fa-gavel me-2"></i>Добавить дело
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="caseForm">
                        <input type="hidden" id="caseId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Клиент *</label>
                                <select class="form-select" id="caseClientId" required>
                                    <option value="">Выберите клиента</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Номер дела *</label>
                                <input type="text" class="form-control" id="caseNumber" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Суд</label>
                                <input type="text" class="form-control" id="caseCourt">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Тип дела</label>
                                <input type="text" class="form-control" id="caseType">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Истец</label>
                                <input type="text" class="form-control" id="casePlaintiff">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ответчик</label>
                                <input type="text" class="form-control" id="caseDefendant">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Сумма иска</label>
                                <input type="number" class="form-control" id="caseClaimAmount" step="0.01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Стадия дела</label>
                                <input type="text" class="form-control" id="caseStage">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Примечания</label>
                            <textarea class="form-control" id="caseNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveCase()">
                        <i class="fas fa-save me-2"></i>Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно услуги -->
    <div class="modal fade" id="serviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="serviceModalTitle">
                        <i class="fas fa-briefcase me-2"></i>Добавить услугу
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="serviceForm">
                        <input type="hidden" id="serviceId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Клиент *</label>
                                <select class="form-select" id="serviceClientId" required>
                                    <option value="">Выберите клиента</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Тип услуги *</label>
                                <input type="text" class="form-control" id="serviceType" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" id="serviceDescription" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Дата услуги</label>
                                <input type="date" class="form-control" id="serviceDate">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Часы</label>
                                <input type="number" class="form-control" id="serviceHours" step="0.5" min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Стоимость</label>
                                <input type="number" class="form-control" id="serviceCost" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Примечания</label>
                            <textarea class="form-control" id="serviceNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveService()">
                        <i class="fas fa-save me-2"></i>Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно платежа -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">
                        <i class="fas fa-money-bill me-2"></i>Добавить платеж
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Клиент *</label>
                                <select class="form-select" id="paymentClientId" required>
                                    <option value="">Выберите клиента</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Сумма *</label>
                                <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Тип платежа</label>
                                <select class="form-select" id="paymentType">
                                    <option value="Оплата услуг">Оплата услуг</option>
                                    <option value="Аванс">Аванс</option>
                                    <option value="Консультация">Консультация</option>
                                    <option value="Представительство">Представительство</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Дата платежа</label>
                                <input type="date" class="form-control" id="paymentDate">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Способ оплаты</label>
                                <select class="form-select" id="paymentMethod">
                                    <option value="Наличные">Наличные</option>
                                    <option value="Банковский перевод">Банковский перевод</option>
                                    <option value="Карта">Карта</option>
                                    <option value="Сбербанк Онлайн">Сбербанк Онлайн</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Номер счета/квитанции</label>
                                <input type="text" class="form-control" id="paymentInvoice">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Примечания</label>
                            <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="savePayment()">
                        <i class="fas fa-save me-2"></i>Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно события -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalTitle">
                        <i class="fas fa-calendar me-2"></i>Добавить событие
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Название события *</label>
                                <input type="text" class="form-control" id="eventTitle" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Тип события *</label>
                                <select class="form-select" id="eventType" required>
                                    <option value="">Выберите тип</option>
                                    <option value="Судебное заседание">Судебное заседание</option>
                                    <option value="Консультация">Консультация</option>
                                    <option value="Встреча с клиентом">Встреча с клиентом</option>
                                    <option value="Документооборот">Документооборот</option>
                                    <option value="Другое">Другое</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Клиент</label>
                                <select class="form-select" id="eventClient">
                                    <option value="">Выберите клиента</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Дело</label>
                                <select class="form-select" id="eventCase">
                                    <option value="">Выберите дело</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Дата *</label>
                                <input type="date" class="form-control" id="eventDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Время</label>
                                <input type="time" class="form-control" id="eventTime">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Место проведения</label>
                            <input type="text" class="form-control" id="eventLocation">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveEvent()">
                        <i class="fas fa-save me-2"></i>Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast для уведомлений -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i>
                <strong class="me-auto">Legal CRM</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- Сообщение будет вставлено через JavaScript -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    
    <script>
        // Legal CRM Web - Основной JavaScript файл
        // Глобальные переменные
        let clientsDataTable, casesDataTable, servicesDataTable, paymentsDataTable, eventsDataTable;
        let currentEditingId = null;
        let currentUser = null;

        // Инициализация при загрузке страницы
        $(document).ready(function() {
            console.log('🚀 Legal CRM Web инициализация...');
            
            // Проверка аутентификации выполняется через main.js
            // Просто инициализируем компоненты
        });

        // Инициализация компонентов
        function initializeComponents() {
            // Инициализация DateTime picker
            flatpickr("input[type='date']", {
                locale: "ru",
                dateFormat: "Y-m-d",
                allowInput: true
            });
            
            flatpickr("input[type='time']", {
                locale: "ru",
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                allowInput: true
            });
            
            // Инициализация Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Обработчик изменения выбора клиента в событии
            $(document).on('change', '#eventClient', function() {
                const clientId = $(this).val();
                loadCasesForClient(clientId);
            });

            // Мобильная статистика - показываем на мобильных устройствах
            if (window.innerWidth <= 768) {
                $('#mobileStats').show();
            }
        }

        // Загрузка всех данных
        function loadAllData() {
            loadClients();
            loadCases();
            loadServices();
            loadPayments();
            loadEvents();
        }

        // Загрузка клиентов
        function loadClients() {
            $.ajax({
                url: '/api/clients',
                method: 'GET',
                success: function(response) {
                    // Backend возвращает {success: true, data: clients}
                    if (response.success) {
                        displayClients(response.data);
                    } else {
                        showNotification('Ошибка загрузки клиентов: ' + response.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка загрузки клиентов:', error);
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Отображение клиентов
        function displayClients(clients) {
            if (clientsDataTable) {
                clientsDataTable.destroy();
            }
            
            const tbody = $('#clients-table tbody');
            tbody.empty();
            
            clients.forEach(function(client) {
                const row = `
                    <tr>
                        <td>${client.id}</td>
                        <td>${client.full_name || client.name || '-'}</td>
                        <td>${client.phone || '-'}</td>
                        <td>${client.email || '-'}</td>
                        <td><span class="badge bg-${(client.status === 'Активный' || client.status === 'active') ? 'success' : 'secondary'}">${client.status || 'Активный'}</span></td>
                        <td>${formatDate(client.created_date || client.created_at)}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary btn-action" onclick="editClient(${client.id})" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" onclick="deleteClient(${client.id})" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            // Инициализация DataTable
            clientsDataTable = $('#clients-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/Russian.json'
                },
                pageLength: 25,
                responsive: true
            });
        }

        // Загрузка дел
        function loadCases() {
            $.ajax({
                url: '/api/cases',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        displayCases(response.data);
                    } else {
                        showNotification('Ошибка загрузки дел: ' + response.error, 'error');
                    }
                },
                error: function() {
                    console.error('Ошибка загрузки дел');
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Отображение дел
        function displayCases(cases) {
            if (casesDataTable) {
                casesDataTable.destroy();
            }
            
            const tbody = $('#cases-table tbody');
            tbody.empty();
            
            cases.forEach(function(case_item) {
                const row = `
                    <tr>
                        <td>${case_item.case_number || '-'}</td>
                        <td>${case_item.client_name || '-'}</td>
                        <td>${case_item.court_name || '-'}</td>
                        <td>${case_item.case_type || '-'}</td>
                        <td>${case_item.case_stage || '-'}</td>
                        <td>${formatDate(case_item.start_date)}</td>
                        <td><span class="badge bg-${(case_item.status === 'Активное' || case_item.status === 'active') ? 'success' : 'secondary'}">${case_item.status || 'Активное'}</span></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary btn-action" onclick="editCase(${case_item.id})" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" onclick="deleteCase(${case_item.id})" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            casesDataTable = $('#cases-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/Russian.json'
                },
                pageLength: 25,
                responsive: true
            });
        }

        // Загрузка услуг
        function loadServices() {
            $.ajax({
                url: '/api/services',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        displayServices(response.data);
                    } else {
                        showNotification('Ошибка загрузки услуг: ' + response.error, 'error');
                    }
                },
                error: function() {
                    console.error('Ошибка загрузки услуг');
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Отображение услуг
        function displayServices(services) {
            if (servicesDataTable) {
                servicesDataTable.destroy();
            }
            
            const tbody = $('#services-table tbody');
            tbody.empty();
            
            services.forEach(function(service) {
                const row = `
                    <tr>
                        <td>${service.service_type || '-'}</td>
                        <td>${service.client_name || '-'}</td>
                        <td>${service.case_number || '-'}</td>
                        <td>${formatDate(service.service_date)}</td>
                        <td>${service.hours || 0}</td>
                        <td>${formatCurrency(service.cost)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteService(${service.id})" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            servicesDataTable = $('#services-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/Russian.json'
                },
                pageLength: 25,
                responsive: true
            });
        }

        // Загрузка платежей
        function loadPayments() {
            $.ajax({
                url: '/api/payments',
                method: 'GET',
                success: function(response) {
                    // Backend возвращает {success: true, data: payments}
                    if (response.success) {
                        displayPayments(response.data);
                    } else {
                        showNotification('Ошибка загрузки платежей: ' + response.error, 'error');
                    }
                },
                error: function() {
                    console.error('Ошибка загрузки платежей');
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Отображение платежей
        function displayPayments(payments) {
            if (paymentsDataTable) {
                paymentsDataTable.destroy();
            }
            
            const tbody = $('#payments-table tbody');
            tbody.empty();
            
            payments.forEach(function(payment) {
                const row = `
                    <tr>
                        <td>${payment.client_name || '-'}</td>
                        <td>${payment.case_number || '-'}</td>
                        <td><strong>${formatCurrency(payment.amount)}</strong></td>
                        <td>${payment.payment_type || '-'}</td>
                        <td>${formatDate(payment.payment_date)}</td>
                        <td>${payment.payment_method || '-'}</td>
                        <td><span class="badge bg-${(payment.status === 'Оплачено' || payment.status === 'paid') ? 'success' : 'warning'}">${payment.status || 'Оплачено'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deletePayment(${payment.id})" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            paymentsDataTable = $('#payments-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/Russian.json'
                },
                pageLength: 25,
                responsive: true
            });
        }

        // Загрузка событий
        function loadEvents() {
            $.ajax({
                url: '/api/events',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        displayEvents(response.data);
                    } else {
                        showNotification('Ошибка загрузки событий: ' + response.error, 'error');
                    }
                },
                error: function() {
                    console.error('Ошибка загрузки событий');
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Отображение событий
        function displayEvents(events) {
            if (eventsDataTable) {
                eventsDataTable.destroy();
            }
            
            const tbody = $('#events-table tbody');
            tbody.empty();
            
            events.forEach(function(event) {
                const row = `
                    <tr>
                        <td>${event.title || '-'}</td>
                        <td>${event.event_type || '-'}</td>
                        <td>${formatDate(event.event_date)}</td>
                        <td>${event.event_time || '-'}</td>
                        <td>${event.client_name || '-'}</td>
                        <td>${event.case_number || '-'}</td>
                        <td><span class="badge bg-${getEventStatusColor(event.status)}">${event.status || 'Запланировано'}</span></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary btn-action" onclick="editEvent(${event.id})" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" onclick="deleteEvent(${event.id})" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            
            eventsDataTable = $('#events-table').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/Russian.json'
                },
                pageLength: 25,
                responsive: true
            });
        }

        // Обновление статистики
        function updateStatistics() {
            $.ajax({
                url: '/api/statistics',
                method: 'GET',
                success: function(response) {
                    // Backend возвращает {success: true, data: stats}
                    if (response.success) {
                        const stats = response.data;
                    
                    // Обновляем основную статистику
                    $('#stats-clients').text(stats.active_clients || 0);
                    $('#stats-cases').text(stats.active_cases || 0);
                    $('#stats-events').text(stats.today_events || 0);
                        $('#stats-income').text(formatCurrency(stats.month_payments || 0));
                        
                        // Обновляем мобильную статистику
                        $('#mobile-clients').text(stats.active_clients || 0);
                        $('#mobile-cases').text(stats.active_cases || 0);
                        $('#mobile-events').text(stats.today_events || 0);
                        $('#mobile-income').text(formatCurrency(stats.month_payments || 0));
                        
                        // Обновляем статистику в отчетах
                        $('#total-clients').text(stats.active_clients || 0);
                        $('#total-cases').text(stats.active_cases || 0);
                        $('#total-income').text(formatCurrency(stats.month_payments || 0));
                        $('#total-services').text(stats.month_services || 0);
                    } else {
                        console.error('Ошибка загрузки статистики:', response.error);
                    }
                },
                error: function() {
                    console.error('Ошибка загрузки статистики');
                }
            });
        }

        // ==================== ФУНКЦИИ КЛИЕНТОВ ====================

        // Открытие модального окна клиента
        function openClientModal(clientId = null) {
            currentEditingId = clientId;
            
            if (clientId) {
                $('#clientModalTitle').html('<i class="fas fa-user-edit me-2"></i>Редактировать клиента');
                
                // Загружаем данные клиента
                $.ajax({
                    url: `/api/clients/${clientId}`,
                    method: 'GET',
                    success: function(response) {
                        const client = response;
                        $('#clientId').val(client.id);
                        $('#clientFullName').val(client.full_name || client.name || '');
                        $('#clientPhone').val(client.phone || '');
                        $('#clientEmail').val(client.email || '');
                        $('#clientAddress').val(client.address || '');
                        $('#clientPassport').val(client.passport_data || client.passport || '');
                        $('#clientInn').val(client.inn || '');
                        $('#clientStatus').val(client.status || 'Активный');
                        $('#clientNotes').val(client.notes || '');
                    }
                });
            } else {
                $('#clientModalTitle').html('<i class="fas fa-user-plus me-2"></i>Добавить клиента');
                $('#clientForm')[0].reset();
                $('#clientId').val('');
            }
            
            $('#clientModal').modal('show');
        }

        // Сохранение клиента
        function saveClient() {
            const formData = {
                name: $('#clientFullName').val().trim(),
                phone: $('#clientPhone').val().trim(),
                email: $('#clientEmail').val().trim(),
                address: $('#clientAddress').val().trim(),
                notes: $('#clientNotes').val().trim()
            };
            
            if (!formData.name) {
                showNotification('Пожалуйста, введите ФИО клиента', 'error');
                return;
            }
            
            const method = currentEditingId ? 'PUT' : 'POST';
            const url = currentEditingId ? `/api/clients/${currentEditingId}` : '/api/clients';
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    showNotification(currentEditingId ? 'Клиент обновлен!' : 'Клиент добавлен!', 'success');
                    $('#clientModal').modal('hide');
                    loadClients();
                    updateStatistics();
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Редактирование клиента
        function editClient(clientId) {
            openClientModal(clientId);
        }

        // Удаление клиента
        function deleteClient(clientId) {
            if (confirm('Вы уверены, что хотите удалить этого клиента? Все связанные данные также будут удалены.')) {
                $.ajax({
                    url: `/api/clients/${clientId}`,
                    method: 'DELETE',
                    success: function(response) {
                        showNotification('Клиент удален!', 'success');
                        loadClients();
                        updateStatistics();
                    },
                    error: function() {
                        showNotification('Ошибка соединения с сервером', 'error');
                    }
                });
            }
        }

        // ==================== ФУНКЦИИ ПЛАТЕЖЕЙ ====================

        // Открытие модального окна платежа
        function openPaymentModal(paymentId = null) {
            currentEditingId = paymentId;
            
            if (paymentId) {
                $('#paymentModalTitle').html('<i class="fas fa-money-bill me-2"></i>Редактировать платеж');
            } else {
                $('#paymentModalTitle').html('<i class="fas fa-plus me-2"></i>Добавить платеж');
                $('#paymentForm')[0].reset();
                $('#paymentId').val('');
            }
            
            // Загружаем список клиентов для выпадающего списка
            loadClientsForSelect('#paymentClientId');
            
            // Устанавливаем текущую дату
            if (!paymentId) {
                $('#paymentDate').val(new Date().toISOString().split('T')[0]);
            }
            
            $('#paymentModal').modal('show');
        }

        // Сохранение платежа
        function savePayment() {
            const formData = {
                client_id: parseInt($('#paymentClientId').val()),
                amount: parseFloat($('#paymentAmount').val()),
                payment_type: $('#paymentType').val(),
                payment_date: $('#paymentDate').val(),
                payment_method: $('#paymentMethod').val(),
                notes: $('#paymentNotes').val().trim()
            };
            
            if (!formData.client_id || !formData.amount) {
                showNotification('Пожалуйста, заполните обязательные поля', 'error');
                return;
            }
            
            const method = currentEditingId ? 'PUT' : 'POST';
            const url = currentEditingId ? `/api/payments/${currentEditingId}` : '/api/payments';
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    showNotification(currentEditingId ? 'Платеж обновлен!' : 'Платеж добавлен!', 'success');
                    $('#paymentModal').modal('hide');
                    loadPayments();
                    updateStatistics();
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // ==================== УТИЛИТЫ ====================

        // Загрузка клиентов в выпадающий список
        function loadClientsForSelect(selectId) {
            $.ajax({
                url: '/api/clients',
                method: 'GET',
                success: function(response) {
                    const select = $(selectId);
                    select.empty();
                    select.append('<option value="">Выберите клиента</option>');
                    
                    if (response.success) {
                        response.data.forEach(function(client) {
                            select.append(`<option value="${client.id}">${client.full_name || client.name}</option>`);
                        });
                    }
                }
            });
        }

        // Инициализация поиска
        function initializeSearch() {
            $('#clients-search').on('keyup', function() {
                if (clientsDataTable) {
                    clientsDataTable.search($(this).val()).draw();
                }
            });
        }

        // Показ уведомлений
        function showNotification(message, type = 'info') {
            const toast = $('#notificationToast');
            const toastMessage = $('#toastMessage');
            
            // Устанавливаем сообщение
            toastMessage.text(message);
            
            // Устанавливаем цвет в зависимости от типа
            const header = toast.find('.toast-header');
            header.removeClass('bg-success bg-warning bg-danger bg-info');
            
            switch(type) {
                case 'success':
                    header.addClass('bg-success');
                    break;
                case 'error':
                    header.addClass('bg-danger');
                    break;
                case 'warning':
                    header.addClass('bg-warning');
                    break;
                default:
                    header.addClass('bg-info');
            }
            
            // Показываем toast
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();
        }

        // Форматирование даты
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleDateString('ru-RU');
        }

        // Форматирование валюты
        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0 ₽';
            
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Получение цвета для статуса события
        function getEventStatusColor(status) {
            switch(status) {
                case 'Запланировано':
                    return 'primary';
                case 'Завершено':
                    return 'success';
                case 'Отменено':
                    return 'danger';
                default:
                    return 'secondary';
            }
        }

        // ==================== PLACEHOLDER FUNCTIONS ====================
        // Для совместимости с кнопками, которые пока не реализованы полностью

        function openCaseModal(caseId = null) {
            showNotification('Функция в разработке', 'warning');
        }

        function saveCase() {
            showNotification('Функция в разработке', 'warning');
        }

        function editCase(caseId) {
            showNotification('Функция в разработке', 'warning');
        }

        function openServiceModal(serviceId = null) {
            showNotification('Функция в разработке', 'warning');
        }

        function saveService() {
            showNotification('Функция в разработке', 'warning');
        }

        function openEventModal(eventId = null) {
            showNotification('Функция в разработке', 'warning');
        }

        function saveEvent() {
            showNotification('Функция в разработке', 'warning');
        }

        function editEvent(eventId) {
            showNotification('Функция в разработке', 'warning');
        }

        function deleteCase(caseId) {
            showNotification('Функция в разработке', 'warning');
        }

        function deleteService(serviceId) {
            showNotification('Функция в разработке', 'warning');
        }

        function deleteEvent(eventId) {
            showNotification('Функция в разработке', 'warning');
        }

        function deletePayment(paymentId) {
            if (confirm('Вы уверены, что хотите удалить этот платеж?')) {
                $.ajax({
                    url: `/api/payments/${paymentId}`,
                    method: 'DELETE',
                    success: function(response) {
                        showNotification('Платеж удален!', 'success');
                        loadPayments();
                        updateStatistics();
                    },
                    error: function() {
                        showNotification('Ошибка соединения с сервером', 'error');
                    }
                });
            }
        }

        // ==================== СИНХРОНИЗАЦИЯ С ЯНДЕКС.ДИСКОМ ====================

        // Загрузка статуса синхронизации при инициализации
        function loadSyncStatus() {
            $.ajax({
                url: '/api/sync/status',
                method: 'GET',
                success: function(response) {
                    if (response.configured) {
                        $('#sync-status-indicator').html('<i class="fas fa-cloud text-white"></i>');
                        $('#sync-status-text').text('Настроено');
                        $('#sync-status-indicator').parent().removeClass('bg-primary bg-warning bg-danger').addClass('bg-success');
                        
                        if (response.needs_sync) {
                            $('#sync-status-indicator').html('<i class="fas fa-exclamation-triangle text-white"></i>');
                            $('#sync-status-text').text('Требуется синхронизация');
                            $('#sync-status-indicator').parent().removeClass('bg-success bg-primary').addClass('bg-warning');
                        }
                    } else {
                        $('#sync-status-indicator').html('<i class="fas fa-exclamation-circle text-white"></i>');
                        $('#sync-status-text').text('Не настроено');
                        $('#sync-status-indicator').parent().removeClass('bg-success bg-primary').addClass('bg-danger');
                    }

                    if (response.last_sync) {
                        const syncDate = new Date(response.last_sync).toLocaleString('ru-RU');
                        $('#last-sync-time').text(syncDate);
                    }

                    $('#backup-count').text(response.backup_files_count || 0);
                    $('#auto-sync-toggle').prop('checked', response.auto_sync_enabled || false);
                },
                error: function() {
                    $('#sync-status-indicator').html('<i class="fas fa-times text-white"></i>');
                    $('#sync-status-text').text('Ошибка связи');
                    $('#sync-status-indicator').parent().removeClass('bg-primary bg-success bg-warning').addClass('bg-danger');
                }
            });
        }

        // Тестирование подключения к Яндекс.Диску
        function testYandexConnection() {
            const username = $('#yandex-username').val().trim();
            const password = $('#yandex-password').val().trim();

            if (!username || !password) {
                showNotification('Введите логин и пароль', 'warning');
                return;
            }

            // Показываем индикатор загрузки
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Проверка...';
            btn.disabled = true;

            $.ajax({
                url: '/api/sync/test',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        showNotification(response.message, 'success');
                    } else {
                        showNotification(response.error, 'error');
                    }
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                },
                complete: function() {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        // Настройка синхронизации с Яндекс.Диском
        function setupYandexSync() {
            const username = $('#yandex-username').val().trim();
            const password = $('#yandex-password').val().trim();

            if (!username || !password) {
                showNotification('Введите логин и пароль', 'warning');
                return;
            }

            showNotification('Настройка подключения...', 'info');

            $.ajax({
                url: '/api/sync/setup',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    username: username,
                    password: password
                }),
                success: function(response) {
                    if (response.success) {
                        showNotification(response.message, 'success');
                        loadSyncStatus();
                    } else {
                        showNotification(response.error, 'error');
                    }
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Синхронизация с облаком
        function uploadToCloud() {
            showNotification('Загрузка данных в облако...', 'info');

            $.ajax({
                url: '/api/sync/upload',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showNotification('Данные успешно синхронизированы с облаком!', 'success');
                        loadSyncStatus();
                        loadBackupHistory();
                    } else {
                        showNotification('Ошибка: ' + (response.error || 'Неизвестная ошибка'), 'error');
                    }
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Синхронизация из облака
        function downloadFromCloud() {
            if (!confirm('Это действие заменит текущие данные на данные из облака. Продолжить?')) {
                return;
            }

            showNotification('Загрузка данных из облака...', 'info');

            $.ajax({
                url: '/api/sync/download',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showNotification('Данные успешно загружены из облака!', 'success');
                        loadSyncStatus();
                        loadAllData(); // Перезагружаем все данные
                    } else {
                        showNotification('Ошибка: ' + (response.error || 'Неизвестная ошибка'), 'error');
                    }
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Переключение автоматической синхронизации
        function toggleAutoSync(toggle) {
            if (toggle.checked) {
                // Включаем автосинхронизацию
                const interval = prompt('Введите интервал синхронизации в минутах (по умолчанию 30):', '30');
                const intervalMinutes = interval ? parseInt(interval) : 30;

                $.ajax({
                    url: '/api/sync/auto/enable',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        interval_minutes: intervalMinutes
                    }),
                    success: function(response) {
                        if (response.success) {
                            showNotification('Автоматическая синхронизация включена', 'success');
                        } else {
                            toggle.checked = false;
                            showNotification(response.error, 'error');
                        }
                    },
                    error: function() {
                        toggle.checked = false;
                        showNotification('Ошибка соединения с сервером', 'error');
                    }
                });
            } else {
                // Отключаем автосинхронизацию
                $.ajax({
                    url: '/api/sync/auto/disable',
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            showNotification('Автоматическая синхронизация отключена', 'info');
                        }
                    },
                    error: function() {
                        showNotification('Ошибка соединения с сервером', 'error');
                    }
                });
            }
        }

        // Загрузка истории резервных копий
        function loadBackupHistory() {
            $.ajax({
                url: '/api/sync/backups',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const tbody = $('#backup-history-body');
                        tbody.empty();

                        if (response.backups.length === 0) {
                            tbody.append(`
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        Резервные копии не найдены
                                    </td>
                                </tr>
                            `);
                        } else {
                            response.backups.forEach(function(backup) {
                                const modifiedDate = backup.modified ? 
                                    new Date(backup.modified).toLocaleString('ru-RU') : 
                                    'Неизвестно';
                                
                                const sizeMB = backup.size ? (backup.size / 1024 / 1024).toFixed(2) + ' МБ' : 'Неизвестно';
                                
                                tbody.append(`
                                    <tr>
                                        <td>${modifiedDate}</td>
                                        <td>${sizeMB}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="restoreFromBackup('${backup.name}')">
                                                <i class="fas fa-undo me-1"></i>Восстановить
                                            </button>
                                        </td>
                                    </tr>
                                `);
                            });
                        }
                    }
                },
                error: function() {
                    $('#backup-history-body').html(`
                        <tr>
                            <td colspan="3" class="text-center text-danger">
                                Ошибка загрузки истории
                            </td>
                        </tr>
                    `);
                }
            });
        }

        // Восстановление из резервной копии
        function restoreFromBackup(backupFilename) {
            if (!confirm('Это действие заменит текущие данные на данные из выбранной резервной копии. Продолжить?')) {
                return;
            }

            showNotification('Восстановление данных...', 'info');

            $.ajax({
                url: '/api/sync/restore',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    backup_filename: backupFilename
                }),
                success: function(response) {
                    if (response.success) {
                        showNotification(response.message, 'success');
                        loadSyncStatus();
                        loadAllData(); // Перезагружаем все данные
                    } else {
                        showNotification('Ошибка: ' + (response.error || 'Неизвестная ошибка'), 'error');
                    }
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Очистка старых резервных копий
        function cleanupOldBackups() {
            if (!confirm('Удалить старые резервные копии (старше 30 дней)?')) {
                return;
            }

            $.ajax({
                url: '/api/sync/cleanup',
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        showNotification(response.message, 'success');
                        loadSyncStatus();
                        loadBackupHistory();
                    } else {
                        showNotification('Ошибка: ' + (response.error || 'Неизвестная ошибка'), 'error');
                    }
                },
                error: function() {
                    showNotification('Ошибка соединения с сервером', 'error');
                }
            });
        }

        // Инициализация синхронизации при переключении на вкладку
        $('#sync-tab').on('shown.bs.tab', function (event) {
            loadSyncStatus();
            loadBackupHistory();
        });
    </script>
</body>
</html>
